<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Trainer Controller</title>
     <style>
        :root {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --accent: #ff5722; /* Zwift-ish Orange */
            --accent-hover: #f4511e;
            --text-main: #ffffff;
            --text-muted: #aaaaaa;
            --success: #4caf50;
            --erg-color: #9c27b0; /* Purple for ERG */
            --border: #333;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        header {
            width: 100%;
            max-width: 600px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }

        h1 { font-size: 1.2rem; font-weight: 600; }

        .status-dot {
            height: 10px;
            width: 10px;
            background-color: #555;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }

        .status-connected {
            background-color: var(--success);
            box-shadow: 0 0 8px var(--success);
        }

        /* Dashboard Grid */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            width: 100%;
            max-width: 600px;
            margin-bottom: 30px;
        }

        .metric-card {
            background-color: var(--card-bg);
            padding: 20px 10px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        .metric-value {
            font-size: 2.5rem;
            font-weight: 700;
            display: block;
            margin-bottom: 5px;
        }

        .metric-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .power-val { color: #ffca28; }
        .cadence-val { color: #42a5f5; }
        .speed-val { color: #66bb6a; }

        /* --- NEW: Mode Switcher Styles --- */
        .mode-toggle-container {
            display: flex;
            justify-content: center;
            margin-bottom: 15px;
            background: #1e1e1e;
            padding: 5px;
            border-radius: 30px;
            border: 1px solid #333;
            max-width: 350px;
            width: 100%;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .mode-btn {
            flex: 1;
            background: transparent;
            border: none;
            color: #aaa;
            padding: 12px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }

        .mode-btn.active {
            color: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        /* Specific active colors */
        #btn-mode-grade.active { background-color: #333; }
        #btn-mode-erg.active { background-color: var(--erg-color); }

        /* Inactive Section Styling */
        .control-section.inactive {
            opacity: 0.3;
            pointer-events: none;
            filter: grayscale(0.8);
        }

        /* Control Panel */
        .control-panel {
            background-color: var(--card-bg);
            width: 100%;
            max-width: 600px;
            border-radius: 16px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
            margin-bottom: 20px;
        }

        .control-panel.grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
        }

        @media (min-width: 500px) {
            .control-panel.grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        .control-section {
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #333;
            transition: border-color 0.3s, opacity 0.3s;
        }
        .control-section.grade { border-color: #4a4a4a; }
        .control-section.erg { border-color: var(--erg-color); }

        .control-label {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-bottom: 10px;
            display: block;
            font-weight: 500;
        }

        .display-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .value-display {
            font-size: 2.5rem;
            font-weight: 800;
        }

        .btn-circle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            font-size: 1.8rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #333;
            color: white;
            transition: transform 0.1s;
            -webkit-tap-highlight-color: transparent;
        }
        .btn-circle:active { transform: scale(0.95); }
        .btn-plus { background-color: var(--accent); }

        /* ERG Button Colors */
        .btn-plus.erg { background-color: var(--erg-color); }
        .btn-minus.erg { background-color: #7b1fa2; }

        /* Advanced Settings Details */
        .advanced-details {
            width: 100%;
            max-width: 600px;
            background: #181818;
            border: 1px solid var(--border);
            border-radius: 12px;
            margin-bottom: 30px;
            overflow: hidden;
        }

        .advanced-details summary {
            padding: 15px;
            cursor: pointer;
            font-weight: 600;
            user-select: none;
            background: var(--card-bg);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .advanced-details summary::after {
            content: '▼';
            font-size: 0.8rem;
            transition: transform 0.3s;
        }

        .advanced-details[open] summary::after {
            transform: rotate(180deg);
        }

        .advanced-content {
            padding: 20px;
            border-top: 1px solid var(--border);
        }

        .setting-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .setting-group:last-child { margin-bottom: 0; }

        .setting-label {
            display: block;
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .setting-desc {
            display: block;
            color: #666;
            font-size: 0.75rem;
            margin-bottom: 10px;
            font-style: italic;
        }

        select, input[type="range"] {
            width: 100%;
            padding: 10px;
            background: #2a2a2a;
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 1rem;
            outline: none;
        }

        select:focus { border-color: var(--accent); }

        /* Range Slider Styling */
        input[type=range] {
            -webkit-appearance: none;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: var(--accent);
            cursor: pointer;
            margin-top: -8px;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #444;
            border-radius: 2px;
        }

        .range-value {
            float: right;
            color: var(--accent);
            font-weight: bold;
        }

        /* Main Connect Button */
        .btn-main {
            background-color: var(--accent);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1rem;
            font-weight: 600;
            border-radius: 30px;
            cursor: pointer;
            width: 100%;
            max-width: 300px;
            transition: background-color 0.2s;
        }
        .btn-main:hover { background-color: var(--accent-hover); }
        .btn-main:disabled {
            background-color: #444;
            cursor: not-allowed;
            opacity: 0.7;
        }

        #error-log {
            color: #ff6b6b;
            margin-top: 20px;
            font-size: 0.8rem;
            text-align: left;
            max-width: 600px;
            background: #2c0b0b;
            padding: 10px;
            border-radius: 8px;
            font-family: monospace;
            display: none;
            width: 100%;
            word-break: break-all;
        }

        @media (max-width: 400px) {
            .dashboard { grid-template-columns: 1fr; }
            .metric-value { font-size: 3rem; }
        }
    </style>
</head>
<body>

    <header>
        <h1>Trainer<span style="color:var(--accent)">Control</span></h1>
        <div id="connection-status">
            <span class="status-dot" id="status-dot"></span>
            <span id="status-text">Disconnected</span>
        </div>
    </header>

    <div class="dashboard">
        <div class="metric-card">
            <span class="metric-value power-val" id="val-power">--</span>
            <span class="metric-label">Watts</span>
        </div>
        <div class="metric-card">
            <span class="metric-value cadence-val" id="val-cadence">--</span>
            <span class="metric-label">RPM</span>
        </div>
        <div class="metric-card">
            <span class="metric-value speed-val" id="val-speed">--</span>
            <span class="metric-label">KPH</span>
        </div>
    </div>

    <!-- Updated Control Panel to support Grid layout for Grade and ERG -->
    <div class="control-panel grid">
        <button id="btn-mode-grade" class="mode-btn active">Grade Mode</button>
        <button id="btn-mode-erg" class="mode-btn">ERG Mode</button>
        <!-- Grade Control Section -->
        <div class="control-section grade">
            <span class="control-label">SIMULATED GRADE</span>
            <div class="display-container">
                <button class="btn-circle btn-minus" id="btn-decrease">−</button>
                <div class="value-display">
                    <span id="val-slope">0.0</span><span style="font-size: 1rem;">%</span>
                </div>
                <button class="btn-circle btn-plus" id="btn-increase">+</button>
            </div>
            <p style="color: #555; font-size: 0.8rem; margin-top: 10px;">Simulate hills</p>
        </div>

        <!-- ERG Control Section -->
        <div class="control-section erg inactive">
            <span class="control-label" style="color: var(--erg-color)">TARGET POWER (ERG)</span>
            <div class="display-container">
                <button class="btn-circle btn-minus erg" id="btn-erg-down">−</button>
                <div class="value-display" style="color: var(--erg-color)">
                    <span id="val-erg">150</span><span style="font-size: 1rem;">W</span>
                </div>
                <button class="btn-circle btn-plus erg" id="btn-erg-up">+</button>
            </div>
            <p style="color: #555; font-size: 0.8rem; margin-top: 10px;">ERG Mode — Set Target Power</p>
        </div>

    </div>

    <details class="advanced-details">
        <summary>Advanced Physics Settings</summary>
        <div class="advanced-content">

            <!-- Wheel Circumference Setting (New Feature) -->
            <div class="setting-group">
                <label class="setting-label">Wheel Circumference</label>
                <span class="setting-desc">Sets the circumference in millimeters (mm) for speed calculation.</span>
                <select id="opt-circumference">
                    <!-- 26" MTB -->
                    <option value="2050">26" x 1.95" (2050 mm)</option>
                    <option value="2070">26" x 2.1" (2070 mm)</option>

                    <!-- 700c Road -->
                    <option value="2096">700c x 23mm (2096 mm)</option>
                    <option value="2136">700c x 28mm (2136 mm)</option>
                    <option value="2146">700c x 30mm (2146 mm)</option>
                    <option value="2155" selected>700c x 32mm (2155 mm) - Default</option>

                    <!-- 700c Cyclocross / Gravel -->
                    <option value="2168">700c x 35mm Gravel (2168 mm)</option>
                    <option value="2200">700c x 40mm Gravel (2200 mm)</option>
                    <option value="2215">700c x 45mm Gravel (2215 mm)</option>

                    <!-- 27.5" MTB -->
                    <option value="2182">27.5" x 2.1" (2182 mm)</option>
                    <option value="2240">27.5" x 2.25" (2240 mm)</option>

                    <!-- 29" MTB -->
                    <option value="2300">29" x 2.2" (2300 mm)</option>
                    <option value="2330">29" x 2.5" (2330 mm)</option>

                    <!-- Small chainring SPEEEEEEED -->
                    <option value="3500">BIG Wheel (3500 mm) - For small chainring speed</option>
                    <option value="3900">Huge Wheel (3900 mm) - For small chainring speed</option>
                </select>
            </div>

            <!-- Crr Setting -->
            <div class="setting-group">
                <label class="setting-label">Rolling Resistance (Crr)</label>
                <span class="setting-desc">Simulates tire friction. Higher values = "sticky" tires (Linear difficulty).</span>
                <select id="opt-crr">
                    <option value="30">Wooden Track (0.003)</option>
                    <option value="40">Smooth Concrete (0.004)</option>
                    <option value="51" selected>Asphalt Road (0.0051) - Default</option>
                    <option value="60">Rough Road (0.006)</option>
                    <option value="80">Gravel / Dirt (0.008)</option>
                </select>
            </div>

            <!-- Cw Setting -->
            <div class="setting-group">
                <label class="setting-label">Aerodynamics (Cw)</label>
                <span class="setting-desc">Simulates wind drag. Higher values = more air resistance at high speeds (Exponential difficulty).</span>
                <select id="opt-cw">
                    <option value="35">Time Trial Bike (0.35)</option>
                    <option value="40">Race Bike / Drops (0.40)</option>
                    <option value="51" selected>Road Bike / Hoods (0.51) - Default</option>
                    <option value="60">Endurance / Relaxed (0.60)</option>
                    <option value="75">MTB / Upright (0.75)</option>
                </select>
            </div>

            <!-- Wind Speed Setting -->
            <div class="setting-group">
                <label class="setting-label">
                    Wind Speed <span class="range-value" id="lbl-wind">0 m/s</span>
                </label>
                <span class="setting-desc">Positive = Headwind (Harder). Negative = Tailwind (Easier).</span>
                <input type="range" id="rng-wind" min="-10" max="10" step="0.5" value="0">
            </div>

        </div>
    </details>

    <button class="btn-main" id="btn-connect">Connect Trainer</button>
    <div id="error-log"></div>

    <script>
        // --- Constants ---
        const FTMS_SERVICE_UUID = '00001826-0000-1000-8000-00805f9b34fb';
        const INDOOR_BIKE_DATA_UUID = '00002ad2-0000-1000-8000-00805f9b34fb';
        const CONTROL_POINT_UUID = '00002ad9-0000-1000-8000-00805f9b34fb';

        const OP_REQUEST_CONTROL = 0x00;
        const OP_SET_TARGET_POWER = 0x05; // ERG Mode
        const OP_SET_SIMULATION_PARAMS = 0x11;
        const OP_SET_CIRCUMFERENCE = 0x12; // OpCode for Set Wheel Circumference

        // --- Global State ---
        let bluetoothDevice = null;
        let controlChar = null;

        // Simulation Parameters
        let simParams = {
            grade: 0.0,   // %
            crr: 51,      // 0.0051
            cw: 51,       // 0.51
            wind: 0,      // m/s
            circumference: 2155 // mm (2.096 meters * 1000)
        };

        let targetErgWatts = 150; // Initial ERG Target

        // --- UI Elements ---
        const els = {
            connectBtn: document.getElementById('btn-connect'),
            statusText: document.getElementById('status-text'),
            statusDot: document.getElementById('status-dot'),
            power: document.getElementById('val-power'),
            cadence: document.getElementById('val-cadence'),
            speed: document.getElementById('val-speed'),
            // Grade
            slope: document.getElementById('val-slope'),
            btnInc: document.getElementById('btn-increase'),
            btnDec: document.getElementById('btn-decrease'),
            // ERG
            ergDisplay: document.getElementById('val-erg'),
            btnErgUp: document.getElementById('btn-erg-up'),
            btnErgDown: document.getElementById('btn-erg-down'),
            // Modes
            btnModeGrade: document.getElementById('btn-mode-grade'),
            btnModeErg: document.getElementById('btn-mode-erg'),
            sectionGrade: document.querySelector('.control-section.grade'),
            sectionErg: document.querySelector('.control-section.erg'),

            errorLog: document.getElementById('error-log'),
            // Advanced
            optCircumference: document.getElementById('opt-circumference'),
            optCrr: document.getElementById('opt-crr'),
            optCw: document.getElementById('opt-cw'),
            rngWind: document.getElementById('rng-wind'),
            lblWind: document.getElementById('lbl-wind')
        };

        // --- Utility ---
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // --- Debounced Control Logic ---
        // Create debounced wrappers for the send functions.
        // This prevents "GATT operation already in progress" errors on rapid UI interaction.
        const debouncedSendSimulationUpdate = debounce(sendSimulationUpdate, 250);
        const debouncedSendTargetPowerUpdate = debounce(sendTargetPowerUpdate, 250);

        // --- Logging ---
        let errorMessages = [];
        function log(msg, isError = false) {
            console.log(msg);

            els.errorLog.style.display = 'block';
            if (!navigator.bluetooth) {
                els.errorLog.innerHTML = "Web Bluetooth is not supported in this browser. Use Chrome/Edge/Bluefy.";
                els.connectBtn.disabled = true;
                return;
            }

            const time = new Date().toLocaleTimeString();
            const entry = `<div>[${time}] ${msg}</div>`;
            // Preserve any "unsupported" banner stored in dataset, but limit runtime errors to last 5
            const unsupportedHtml = els.errorLog.dataset.unsupportedHtml || '';
            errorMessages.push(entry);
            if (errorMessages.length > 5) errorMessages.shift();
            els.errorLog.innerHTML = unsupportedHtml + errorMessages.join('');
        }

        function updateStatus(connected) {
            if (connected) {
                els.statusText.innerText = "Connected";
                els.statusDot.classList.add('status-connected');
                els.connectBtn.innerText = "Disconnect";
                els.connectBtn.style.backgroundColor = "#333";
            } else {
                els.statusText.innerText = "Disconnected";
                els.statusDot.classList.remove('status-connected');
                els.connectBtn.innerText = "Connect Trainer";
                els.connectBtn.style.backgroundColor = "";
                els.errorLog.innerHTML = '';
                els.errorLog.style.display = 'none';
                els.power.innerText = "--";
                els.cadence.innerText = "--";
                els.speed.innerText = "--";
            }
        }

        // --- Bluetooth Connection ---
        async function onConnectClick() {
            if (bluetoothDevice && bluetoothDevice.gatt.connected) {
                bluetoothDevice.gatt.disconnect();
                return;
            }

            try {
                log("Scanning for FTMS devices...");
                bluetoothDevice = await navigator.bluetooth.requestDevice({
                    filters: [{ services: [FTMS_SERVICE_UUID] }]
                });

                bluetoothDevice.addEventListener('gattserverdisconnected', onDisconnected);

                log("Connecting to GATT...");
                const server = await bluetoothDevice.gatt.connect();
                const service = await server.getPrimaryService(FTMS_SERVICE_UUID);

                log("Subscribing to Data...");
                const dataChar = await service.getCharacteristic(INDOOR_BIKE_DATA_UUID);
                await dataChar.startNotifications();
                dataChar.addEventListener('characteristicvaluechanged', handleBikeData);

                log("Setting up Control Point...");
                try {
                    controlChar = await service.getCharacteristic(CONTROL_POINT_UUID);
                    // Critical: Enable Indications for Control Point
                    await controlChar.startNotifications();

                    log("Requesting control (OpCode 0x00)...");
                    await requestControl();

                    // --- IMPORTANT: ADD A DELAY TO ALLOW TRAINER TO TRANSITION TO 'IN USE' STATE ---
                    await new Promise(resolve => setTimeout(resolve, 500));
                    log("Control requested. Sending configuration parameters...");

                    // Send initial parameters and circumference
                    await sendSimulationUpdate();
                    await sendCircumferenceUpdate();
                } catch (e) {
                    log("Control Point Setup Error: " + e.message, true);
                }

                updateStatus(true);
                log("Ready to ride!");

            } catch (error) {
                log("Connection Error: " + error.message, true);
                updateStatus(false);
            }
        }

        function onDisconnected() {
            log("Disconnected");
            updateStatus(false);
            bluetoothDevice = null;
            controlChar = null;
        }

        // --- Data Parsing ---
        function handleBikeData(event) {
            const value = event.target.value;
            let index = 0;
            const flags = value.getUint16(index, true);
            index += 2;

            const isSet = (bit) => (flags & (1 << bit)) !== 0;

            // Speed (Mandatory usually)
            if (value.byteLength >= index + 2) {
                const speedRaw = value.getUint16(index, true);
                els.speed.innerText = (speedRaw * 0.01).toFixed(1);
                index += 2;
            }

            if (isSet(1)) index += 2; // Avg Speed

            // Cadence
            if (isSet(2)) {
                if (value.byteLength >= index + 2) {
                    els.cadence.innerText = Math.round(value.getUint16(index, true) * 0.5);
                    index += 2;
                }
            }

            if (isSet(3)) index += 2; // Avg Cadence
            if (isSet(4)) index += 3; // Distance
            if (isSet(5)) index += 2; // Resistance Level

            // Power
            if (isSet(6)) {
                if (value.byteLength >= index + 2) {
                    els.power.innerText = value.getInt16(index, true);
                    index += 2;
                }
            }
        }

        // --- Control Logic ---
        async function requestControl() {
            if (!controlChar) return;
            const payload = new Uint8Array([OP_REQUEST_CONTROL]);
            await controlChar.writeValue(payload);
        }

        async function sendSimulationUpdate() {
            if (!controlChar) return;

            // 7 Bytes: [OpCode, Wind(2), Grade(2), Crr(1), Cw(1)]
            const buffer = new ArrayBuffer(7);
            const view = new DataView(buffer);

            // 1. OpCode (0x11)
            view.setUint8(0, OP_SET_SIMULATION_PARAMS);

            // 2. Wind Speed (m/s * 1000)
            view.setInt16(1, Math.round(simParams.wind * 1000), true);

            // 3. Grade (% * 100)
            view.setInt16(3, Math.round(simParams.grade * 100), true);

            // 4. Crr (Coefficient * 10000)
            view.setUint8(5, parseInt(simParams.crr));

            // 5. Cw (kg/m * 100)
            view.setUint8(6, parseInt(simParams.cw));

            try {
                await controlChar.writeValue(buffer);
                log(`Sent: Grade:${simParams.grade}%, Wind:${simParams.wind}, Crr:${simParams.crr}, Cw:${simParams.cw}`);
            } catch (e) {
                log("Simulation Write failed: " + e.message, true);
            }
        }

        async function sendCircumferenceUpdate() {
            if (!controlChar) return;

            const mm = simParams.circumference;
            const encoded = mm * 10; // because FTMS is in 0.1 mm units

            const buffer = new ArrayBuffer(3);
            const view = new DataView(buffer);

            view.setUint8(0, OP_SET_CIRCUMFERENCE);
            view.setUint16(1, encoded, true);

            try {
                await controlChar.writeValue(buffer);
                log(`Sent FTMS Wheel Circumference: ${mm} mm (encoded ${encoded})`);
            } catch (e) {
                log("Circumference Write failed: " + e.message, true);
            }
        }

        // --- ERG Mode (Target Power) ---
        async function sendTargetPowerUpdate(watts) {
            if (!controlChar) return;

            // Safety clamp (0 to 2000W)
            watts = Math.max(0, Math.min(2000, watts));

            // 3 Bytes: [OpCode, Power (2)]
            const buffer = new ArrayBuffer(3);
            const view = new DataView(buffer);

            view.setUint8(0, OP_SET_TARGET_POWER);
            view.setUint16(1, watts, true); // Watts (UINT16, LSB first)

            try {
                await controlChar.writeValue(buffer);
                log(`Trainer Mode: ERG. Target: ${watts}W (OpCode 0x05)`);
                // On success, commit the new power value to our global state.
                targetErgWatts = watts;
            } catch (e) {
                log("Target Power Write failed: " + e.message, true);
                // On failure, revert the UI to the last known good value.
                els.ergDisplay.innerText = targetErgWatts;
            }
        }

        function checkConnected() {
            if (!bluetoothDevice || !bluetoothDevice.gatt.connected) {
                log("Connect trainer first.", true);
                return false;
            }
            return true;
        }

        // --- UI Event Handlers ---

        // Mode Switching Logic
        function setMode(mode) {
            if (mode === 'grade') {
                els.btnModeGrade.classList.add('active');
                els.btnModeErg.classList.remove('active');

                els.sectionGrade.classList.remove('inactive');
                els.sectionErg.classList.add('inactive');

                if (checkConnected()) {
                    debouncedSendSimulationUpdate(); // Force switch to Sim Mode
                }
            } else {
                els.btnModeGrade.classList.remove('active');
                els.btnModeErg.classList.add('active');

                els.sectionGrade.classList.add('inactive');
                els.sectionErg.classList.remove('inactive');

                if (checkConnected()) {
                    debouncedSendTargetPowerUpdate(targetErgWatts); // Force switch to ERG Mode
                }
            }
        }

        els.btnModeGrade.addEventListener('click', () => setMode('grade'));
        els.btnModeErg.addEventListener('click', () => setMode('erg'));

        // Grade Controls
        function updateGrade(newGrade) {
            if (!checkConnected()) return;
            // Clamp between -15% and +20% (Hardware limits usually around there)
            if (newGrade > 20) newGrade = 20;
            if (newGrade < -15) newGrade = -15;

            simParams.grade = parseFloat(newGrade.toFixed(1));

            // UI Update
            els.slope.innerText = (simParams.grade > 0 ? "+" : "") + simParams.grade.toFixed(1);

            setMode('grade');
        }

        function updateErg(change) {
            if (!checkConnected()) return;
            // Read from the UI, not the state variable, for immediate feedback on rapid clicks
            let currentWatts = parseInt(els.ergDisplay.innerText) || targetErgWatts;
            const newWatts = currentWatts + change;
            els.ergDisplay.innerText = newWatts; // Optimistically update UI immediately
            debouncedSendTargetPowerUpdate(newWatts);
        }

        els.btnInc.addEventListener('click', () => updateGrade(simParams.grade + 0.5));
        els.btnDec.addEventListener('click', () => updateGrade(simParams.grade - 0.5));

        // ERG Controls
        els.btnErgUp.addEventListener('click', () => updateErg(5));
        els.btnErgDown.addEventListener('click', () => updateErg(-5));

        // Circumference Control
        els.optCircumference.addEventListener('change', (e) => {
            simParams.circumference = parseInt(e.target.value);
            sendCircumferenceUpdate();
        });

        // Advanced Controls
        els.optCrr.addEventListener('change', (e) => {
            simParams.crr = e.target.value;
            if (els.btnModeGrade.classList.contains('active')) debouncedSendSimulationUpdate();
        });

        els.optCw.addEventListener('change', (e) => {
            simParams.cw = e.target.value;
            if (els.btnModeGrade.classList.contains('active')) debouncedSendSimulationUpdate();
        });

        els.rngWind.addEventListener('input', (e) => {
            simParams.wind = parseFloat(e.target.value);
            els.lblWind.innerText = (simParams.wind > 0 ? "+" : "") + simParams.wind + " m/s";
            if (els.btnModeGrade.classList.contains('active')) debouncedSendSimulationUpdate();
        });

        // Re-attach the connect button listener
        els.connectBtn.addEventListener('click', onConnectClick);

        // --- Keyboard Shortcuts ---
        document.addEventListener('keydown', (e) => {
            // Don't interfere if user is typing in an input
            if (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'SELECT') {
                return;
            }

            const isGradeMode = els.btnModeGrade.classList.contains('active');
            let handled = false;

            switch (e.key) {
                case 'Add':
                case '+':
                    isGradeMode ? updateGrade(simParams.grade + 0.1) : updateErg(5);
                    handled = true;
                    break;
                case 'Subtract':
                case '-':
                    isGradeMode ? updateGrade(simParams.grade - 0.1) : updateErg(-5);
                    handled = true;
                    break;
                case 'ArrowUp':
                    isGradeMode ? updateGrade(simParams.grade + 0.5) : updateErg(10);
                    handled = true;
                    break;
                case 'ArrowDown':
                    isGradeMode ? updateGrade(simParams.grade - 0.5) : updateErg(-10);
                    handled = true;
                    break;
                case 'e':
                case 'E':
                    setMode('erg');
                    handled = true;
                    break;
                case 'g':
                case 'G':
                    setMode('grade');
                    handled = true;
                    break;
            }

            if (handled) {
                e.preventDefault(); // Prevent page scrolling with arrow keys
            }
        });

        // --- Init ---
        // Initialize circumference dropdown value
        els.optCircumference.value = simParams.circumference;
        els.ergDisplay.innerText = targetErgWatts;

        if (!navigator.bluetooth) {
            els.errorLog.style.display = 'block';
            els.errorLog.innerHTML = "Web Bluetooth is not supported in this browser. Use Chrome/Edge/Bluefy.";
            els.connectBtn.disabled = true;
        }

    </script>
</body>
</html>